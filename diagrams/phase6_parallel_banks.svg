<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="780" height="620" viewBox="0 0 780 620"
     font-family="Monaco, Consolas, 'Courier New', monospace">

  <!-- Background -->
  <rect width="780" height="620" rx="10" fill="#1e1e2e"/>

  <!-- Title bar -->
  <rect x="0" y="0" width="780" height="40" rx="10" fill="#313244"/>
  <rect x="0" y="30" width="780" height="10" fill="#313244"/>
  <text x="390" y="24" text-anchor="middle" font-size="13" fill="#cdd6f4"
        font-family="'Segoe UI', 'Helvetica Neue', Arial, sans-serif">
    Phase 6: Parallel Accumulator Banks (N=4)
  </text>

  <!-- ===== Input Section ===== -->

  <!-- Single-stream input -->
  <rect x="40" y="60" width="200" height="50" rx="6" fill="#313244" stroke="#f9e2af" stroke-width="1.5"/>
  <text x="140" y="82" text-anchor="middle" font-size="11" fill="#f9e2af">delta_in[63:0]</text>
  <text x="140" y="98" text-anchor="middle" font-size="9" fill="#6c7086">delta_valid</text>

  <!-- Parallel input -->
  <rect x="280" y="60" width="240" height="50" rx="6" fill="#313244" stroke="#f9e2af" stroke-width="1.5"/>
  <text x="400" y="82" text-anchor="middle" font-size="11" fill="#f9e2af">delta_parallel_in[N*64-1:0]</text>
  <text x="400" y="98" text-anchor="middle" font-size="9" fill="#6c7086">delta_parallel_valid[N-1:0]</text>

  <!-- Mode selector -->
  <rect x="560" y="65" width="180" height="40" rx="6" fill="#45475a" stroke="#cba6f7" stroke-width="1"/>
  <text x="650" y="82" text-anchor="middle" font-size="10" fill="#cba6f7">parallel_mode</text>
  <text x="650" y="96" text-anchor="middle" font-size="9" fill="#6c7086">0=round-robin  1=N-port</text>

  <!-- Arrows from inputs to distributor -->
  <line x1="140" y1="110" x2="140" y2="140" stroke="#f9e2af" stroke-width="1.5"/>
  <polygon points="140,145 136,138 144,138" fill="#f9e2af"/>
  <line x1="400" y1="110" x2="400" y2="140" stroke="#f9e2af" stroke-width="1.5"/>
  <polygon points="400,145 396,138 404,138" fill="#f9e2af"/>

  <!-- ===== Round-Robin Distributor ===== -->
  <rect x="60" y="145" width="460" height="45" rx="6" fill="#313244" stroke="#89b4fa" stroke-width="1.5"/>
  <text x="290" y="165" text-anchor="middle" font-size="12" fill="#89b4fa">Round-Robin Distributor</text>
  <text x="290" y="180" text-anchor="middle" font-size="9" fill="#6c7086">bank_sel[$clog2(N)-1:0] counter, advances on delta_valid</text>

  <!-- Mode arrow -->
  <line x1="560" y1="85" x2="525" y2="167" stroke="#cba6f7" stroke-width="1" stroke-dasharray="4,3"/>
  <polygon points="525,167 530,160 522,160" fill="#cba6f7"/>

  <!-- Arrows from distributor to banks -->
  <line x1="140" y1="190" x2="140" y2="225" stroke="#89b4fa" stroke-width="1.5"/>
  <polygon points="140,230 136,223 144,223" fill="#89b4fa"/>
  <line x1="260" y1="190" x2="260" y2="225" stroke="#89b4fa" stroke-width="1.5"/>
  <polygon points="260,230 256,223 264,223" fill="#89b4fa"/>
  <line x1="380" y1="190" x2="380" y2="225" stroke="#89b4fa" stroke-width="1.5"/>
  <polygon points="380,230 376,223 384,223" fill="#89b4fa"/>
  <line x1="500" y1="190" x2="500" y2="225" stroke="#89b4fa" stroke-width="1.5"/>
  <polygon points="500,230 496,223 504,223" fill="#89b4fa"/>

  <!-- ===== N=4 Accumulator Banks ===== -->

  <!-- Bank 0 -->
  <rect x="80" y="230" width="120" height="70" rx="6" fill="#1e1e2e" stroke="#89b4fa" stroke-width="2"/>
  <text x="140" y="255" text-anchor="middle" font-size="12" fill="#89b4fa" font-weight="bold">Bank 0</text>
  <text x="140" y="272" text-anchor="middle" font-size="10" fill="#cdd6f4">atomik_delta_acc</text>
  <text x="140" y="290" text-anchor="middle" font-size="9" fill="#6c7086">XOR accumulate</text>

  <!-- Bank 1 -->
  <rect x="200" y="230" width="120" height="70" rx="6" fill="#1e1e2e" stroke="#89b4fa" stroke-width="2"/>
  <text x="260" y="255" text-anchor="middle" font-size="12" fill="#89b4fa" font-weight="bold">Bank 1</text>
  <text x="260" y="272" text-anchor="middle" font-size="10" fill="#cdd6f4">atomik_delta_acc</text>
  <text x="260" y="290" text-anchor="middle" font-size="9" fill="#6c7086">XOR accumulate</text>

  <!-- Bank 2 -->
  <rect x="320" y="230" width="120" height="70" rx="6" fill="#1e1e2e" stroke="#89b4fa" stroke-width="2"/>
  <text x="380" y="255" text-anchor="middle" font-size="12" fill="#89b4fa" font-weight="bold">Bank 2</text>
  <text x="380" y="272" text-anchor="middle" font-size="10" fill="#cdd6f4">atomik_delta_acc</text>
  <text x="380" y="290" text-anchor="middle" font-size="9" fill="#6c7086">XOR accumulate</text>

  <!-- Bank 3 -->
  <rect x="440" y="230" width="120" height="70" rx="6" fill="#1e1e2e" stroke="#89b4fa" stroke-width="2"/>
  <text x="500" y="255" text-anchor="middle" font-size="12" fill="#89b4fa" font-weight="bold">Bank 3</text>
  <text x="500" y="272" text-anchor="middle" font-size="10" fill="#cdd6f4">atomik_delta_acc</text>
  <text x="500" y="290" text-anchor="middle" font-size="9" fill="#6c7086">XOR accumulate</text>

  <!-- Arrows from banks to merge level 1 -->
  <line x1="140" y1="300" x2="140" y2="335" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="260" y1="300" x2="260" y2="335" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="380" y1="300" x2="380" y2="335" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="500" y1="300" x2="500" y2="335" stroke="#a6e3a1" stroke-width="1.5"/>

  <!-- Merge from bank 0 and 1 to XOR node -->
  <line x1="140" y1="335" x2="200" y2="350" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="260" y1="335" x2="200" y2="350" stroke="#a6e3a1" stroke-width="1.5"/>
  <!-- Merge from bank 2 and 3 to XOR node -->
  <line x1="380" y1="335" x2="440" y2="350" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="500" y1="335" x2="440" y2="350" stroke="#a6e3a1" stroke-width="1.5"/>

  <!-- ===== Merge Tree Level 1 ===== -->
  <rect x="170" y="345" width="60" height="35" rx="6" fill="#1e1e2e" stroke="#a6e3a1" stroke-width="2"/>
  <text x="200" y="367" text-anchor="middle" font-size="12" fill="#a6e3a1" font-weight="bold">XOR</text>

  <rect x="410" y="345" width="60" height="35" rx="6" fill="#1e1e2e" stroke="#a6e3a1" stroke-width="2"/>
  <text x="440" y="367" text-anchor="middle" font-size="12" fill="#a6e3a1" font-weight="bold">XOR</text>

  <!-- Arrows to merge level 2 -->
  <line x1="200" y1="380" x2="200" y2="400" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="440" y1="380" x2="440" y2="400" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="200" y1="400" x2="320" y2="415" stroke="#a6e3a1" stroke-width="1.5"/>
  <line x1="440" y1="400" x2="320" y2="415" stroke="#a6e3a1" stroke-width="1.5"/>

  <!-- ===== Merge Tree Level 2 (Root) ===== -->
  <rect x="285" y="410" width="70" height="40" rx="6" fill="#1e1e2e" stroke="#a6e3a1" stroke-width="2"/>
  <text x="320" y="435" text-anchor="middle" font-size="12" fill="#a6e3a1" font-weight="bold">XOR</text>

  <!-- Label: Combinational merge tree -->
  <text x="580" y="350" font-size="10" fill="#a6e3a1">Combinational</text>
  <text x="580" y="364" font-size="10" fill="#a6e3a1">merge tree</text>
  <text x="580" y="378" font-size="9" fill="#6c7086">log2(N) depth</text>
  <text x="580" y="392" font-size="9" fill="#6c7086">no carry chain</text>
  <line x1="575" y1="365" x2="475" y2="365" stroke="#a6e3a1" stroke-width="1" stroke-dasharray="3,3"/>

  <!-- Arrow from merge root to merged_accumulator -->
  <line x1="320" y1="450" x2="320" y2="475" stroke="#cba6f7" stroke-width="1.5"/>
  <polygon points="320,480 316,473 324,473" fill="#cba6f7"/>

  <!-- ===== State Reconstruction ===== -->
  <rect x="200" y="480" width="240" height="50" rx="6" fill="#1e1e2e" stroke="#cba6f7" stroke-width="2"/>
  <text x="320" y="502" text-anchor="middle" font-size="12" fill="#cba6f7" font-weight="bold">State Reconstruction</text>
  <text x="320" y="519" text-anchor="middle" font-size="10" fill="#cdd6f4">current_state = initial_state XOR merged_acc</text>

  <!-- Initial state input arrow -->
  <rect x="600" y="487" width="150" height="36" rx="6" fill="#313244" stroke="#cba6f7" stroke-width="1"/>
  <text x="675" y="508" text-anchor="middle" font-size="10" fill="#cba6f7">initial_state[63:0]</text>
  <line x1="600" y1="505" x2="445" y2="505" stroke="#cba6f7" stroke-width="1" stroke-dasharray="4,3"/>
  <polygon points="445,505 452,501 452,509" fill="#cba6f7"/>

  <!-- Output arrow -->
  <line x1="320" y1="530" x2="320" y2="555" stroke="#f9e2af" stroke-width="1.5"/>
  <polygon points="320,560 316,553 324,553" fill="#f9e2af"/>

  <!-- Output label -->
  <rect x="230" y="560" width="180" height="35" rx="6" fill="#313244" stroke="#f9e2af" stroke-width="1.5"/>
  <text x="320" y="582" text-anchor="middle" font-size="12" fill="#f9e2af" font-weight="bold">current_state[63:0]</text>

  <!-- ===== Annotations ===== -->
  <!-- Throughput formula -->
  <text x="620" y="240" font-size="11" fill="#cdd6f4">Throughput:</text>
  <text x="620" y="257" font-size="10" fill="#a6e3a1">N x Fmax ops/sec</text>
  <text x="620" y="274" font-size="9" fill="#6c7086">N=4 @ 94.5MHz</text>
  <text x="620" y="288" font-size="9" fill="#6c7086">= 378 Mops/sec</text>

  <!-- Latency annotation -->
  <text x="620" y="445" font-size="11" fill="#cdd6f4">Latency:</text>
  <text x="620" y="462" font-size="10" fill="#a6e3a1">1 cycle (constant)</text>

  <!-- Algebraic properties -->
  <rect x="30" y="358" width="130" height="72" rx="4" fill="#313244" opacity="0.8"/>
  <text x="40" y="376" font-size="9" fill="#cba6f7">Algebraic Guarantees</text>
  <text x="40" y="392" font-size="8" fill="#6c7086">Commutativity (Lean4)</text>
  <text x="40" y="404" font-size="8" fill="#6c7086">Associativity (Lean4)</text>
  <text x="40" y="416" font-size="8" fill="#6c7086">Self-inverse (Lean4)</text>
  <text x="40" y="426" font-size="8" fill="#a6e3a1">Bank order irrelevant</text>

</svg>
