# H264Delta
# 
# Delta-based video frame processing for H.264 streams. Tracks frame deltas and motion vectors using XOR accumulation for bandwidth-efficient video transport.
# 
# Generated by ATOMiK SDK Generator

from __future__ import annotations

from typing import Optional

class H264Delta:
    """
    Delta-based video frame processing for H.264 streams. Tracks frame deltas and motion vectors using XOR accumulation for bandwidth-efficient video transport.

    Delta Fields:
        frame_delta: delta_stream (256-bit)
        motion_vector: parameter_delta (256-bit)

    Operations:
        accumulate: Available
        reconstruct: Available
        rollback: Available

    """

    def __init__(self):
        """Initialize delta-state module."""
        self._frame_delta_initial: int = 0
        self._frame_delta_accumulator: int = 0
        self._motion_vector_initial: int = 0
        self._motion_vector_accumulator: int = 0
        self._frame_delta_history: list[int] = []
        self._history_depth = 512
        self._motion_vector_history: list[int] = []
        self._history_depth = 512

    def load_frame_delta(self, initial_state: int) -> None:
        """
        Load initial state for frame_delta.

        Args:
            initial_state: Initial 256-bit state value
        """
        self._frame_delta_initial = initial_state & 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff

    def accumulate_frame_delta(self, delta: int) -> int:
        """
        Accumulate delta for frame_delta via XOR.

        Args:
            delta: 256-bit delta value

        Returns:
            Updated accumulator value
        """
        # Save to history
        self._frame_delta_history.append(delta)
        if len(self._frame_delta_history) > self._history_depth:
                self._frame_delta_history.pop(0)

        self._frame_delta_accumulator ^= (delta & 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)
        return self._frame_delta_accumulator

    def reconstruct_frame_delta(self) -> int:
        """
        Reconstruct current state for frame_delta.

        Returns:
            Current state value
        """
        return (self._frame_delta_initial ^ self._frame_delta_accumulator) & 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff

    def load_motion_vector(self, initial_state: int) -> None:
        """
        Load initial state for motion_vector.

        Args:
            initial_state: Initial 256-bit state value
        """
        self._motion_vector_initial = initial_state & 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff

    def accumulate_motion_vector(self, delta: int) -> int:
        """
        Accumulate delta for motion_vector via XOR.

        Args:
            delta: 256-bit delta value

        Returns:
            Updated accumulator value
        """
        # Save to history
        self._motion_vector_history.append(delta)
        if len(self._motion_vector_history) > self._history_depth:
                self._motion_vector_history.pop(0)

        self._motion_vector_accumulator ^= (delta & 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)
        return self._motion_vector_accumulator

    def reconstruct_motion_vector(self) -> int:
        """
        Reconstruct current state for motion_vector.

        Returns:
            Current state value
        """
        return (self._motion_vector_initial ^ self._motion_vector_accumulator) & 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff

    def rollback(self, steps: int = 1) -> bool:
        """
        Rollback state by reversing recent deltas.

        Args:
            steps: Number of deltas to rollback

        Returns:
            True if rollback successful
        """
        if steps > len(self._frame_delta_history):
            return False

        for _ in range(steps):
            delta = self._frame_delta_history.pop()
            self._frame_delta_accumulator ^= delta
            delta = self._motion_vector_history.pop()
            self._motion_vector_accumulator ^= delta

        return True

    def is_accumulator_zero(self, field_name: Optional[str] = None) -> bool:
        """
        Check if accumulator is zero (no pending deltas).

        Args:
            field_name: Optional field name to check (None = check all)

        Returns:
            True if accumulator(s) are zero
        """
        if field_name:
            return getattr(self, f"_{field_name}_accumulator") == 0

        return self._frame_delta_accumulator == 0 and self._motion_vector_accumulator == 0