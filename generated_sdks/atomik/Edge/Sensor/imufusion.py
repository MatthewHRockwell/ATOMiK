# IMUFusion
# 
# Edge sensor fusion for IMU devices. Accumulates accelerometer and gyroscope deltas with bitmask alert tracking for anomaly detection.
# 
# Generated by ATOMiK SDK Generator

from __future__ import annotations

from typing import Optional

class IMUFusion:
    """
    Edge sensor fusion for IMU devices. Accumulates accelerometer and gyroscope deltas with bitmask alert tracking for anomaly detection.

    Delta Fields:
        motion_delta: delta_stream (64-bit)
        alert_flags: bitmask_delta (64-bit)

    Operations:
        accumulate: Available
        reconstruct: Available
        rollback: Available

    """

    def __init__(self):
        """Initialize delta-state module."""
        self._motion_delta_initial: int = 0
        self._motion_delta_accumulator: int = 0
        self._alert_flags_initial: int = 0
        self._alert_flags_accumulator: int = 0
        self._motion_delta_history: list[int] = []
        self._history_depth = 1024
        self._alert_flags_history: list[int] = []
        self._history_depth = 1024

    def load_motion_delta(self, initial_state: int) -> None:
        """
        Load initial state for motion_delta.

        Args:
            initial_state: Initial 64-bit state value
        """
        self._motion_delta_initial = initial_state & 0xffffffffffffffff

    def accumulate_motion_delta(self, delta: int) -> int:
        """
        Accumulate delta for motion_delta via XOR.

        Args:
            delta: 64-bit delta value

        Returns:
            Updated accumulator value
        """
        # Save to history
        self._motion_delta_history.append(delta)
        if len(self._motion_delta_history) > self._history_depth:
                self._motion_delta_history.pop(0)

        self._motion_delta_accumulator ^= (delta & 0xffffffffffffffff)
        return self._motion_delta_accumulator

    def reconstruct_motion_delta(self) -> int:
        """
        Reconstruct current state for motion_delta.

        Returns:
            Current state value
        """
        return (self._motion_delta_initial ^ self._motion_delta_accumulator) & 0xffffffffffffffff

    def load_alert_flags(self, initial_state: int) -> None:
        """
        Load initial state for alert_flags.

        Args:
            initial_state: Initial 64-bit state value
        """
        self._alert_flags_initial = initial_state & 0xffffffffffffffff

    def accumulate_alert_flags(self, delta: int) -> int:
        """
        Accumulate delta for alert_flags via XOR.

        Args:
            delta: 64-bit delta value

        Returns:
            Updated accumulator value
        """
        # Save to history
        self._alert_flags_history.append(delta)
        if len(self._alert_flags_history) > self._history_depth:
                self._alert_flags_history.pop(0)

        self._alert_flags_accumulator ^= (delta & 0xffffffffffffffff)
        return self._alert_flags_accumulator

    def reconstruct_alert_flags(self) -> int:
        """
        Reconstruct current state for alert_flags.

        Returns:
            Current state value
        """
        return (self._alert_flags_initial ^ self._alert_flags_accumulator) & 0xffffffffffffffff

    def rollback(self, steps: int = 1) -> bool:
        """
        Rollback state by reversing recent deltas.

        Args:
            steps: Number of deltas to rollback

        Returns:
            True if rollback successful
        """
        if steps > len(self._motion_delta_history):
            return False

        for _ in range(steps):
            delta = self._motion_delta_history.pop()
            self._motion_delta_accumulator ^= delta
            delta = self._alert_flags_history.pop()
            self._alert_flags_accumulator ^= delta

        return True

    def is_accumulator_zero(self, field_name: Optional[str] = None) -> bool:
        """
        Check if accumulator is zero (no pending deltas).

        Args:
            field_name: Optional field name to check (None = check all)

        Returns:
            True if accumulator(s) are zero
        """
        if field_name:
            return getattr(self, f"_{field_name}_accumulator") == 0

        return self._motion_delta_accumulator == 0 and self._alert_flags_accumulator == 0