# ATOMiK CI/CD Pipeline - Phase Validation Workflow
# Validates each development phase against defined gates

name: Validate Phase

on:
  push:
    branches: [main, develop, 'phase/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      phase:
        description: 'Phase to validate (1-4 or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - 'all'

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  PYTHON_VERSION: '3.11'
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      math: ${{ steps.filter.outputs.math }}
      experiments: ${{ steps.filter.outputs.experiments }}
      hardware: ${{ steps.filter.outputs.hardware }}
      software: ${{ steps.filter.outputs.software }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            math:
              - 'math/**'
            experiments:
              - 'experiments/**'
            hardware:
              - 'hardware/**'
            software:
              - 'software/**'

  validate-phase-1:
    name: Phase 1 - Mathematical Formalization
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.math == 'true' ||
      github.event.inputs.phase == '1' ||
      github.event.inputs.phase == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install numpy scipy sympy matplotlib pytest
      
      - name: Run eigenvalue analysis
        run: |
          if [ -f "math/proofs/eigenvalue_analysis.py" ]; then
            python math/proofs/eigenvalue_analysis.py
          else
            echo "::warning::eigenvalue_analysis.py not found - skipping"
          fi
      
      - name: Run reconstruction test
        run: |
          if [ -f "math/validation/test_reconstruction.py" ]; then
            python math/validation/test_reconstruction.py
          else
            echo "::warning::test_reconstruction.py not found - skipping"
          fi
      
      - name: Verify LaTeX compilation
        run: |
          sudo apt-get update && sudo apt-get install -y texlive-latex-base texlive-latex-extra
          cd math/proofs
          for tex_file in *.tex; do
            if [ -f "$tex_file" ]; then
              pdflatex -interaction=nonstopmode "$tex_file" || echo "::warning::$tex_file compilation failed"
            fi
          done
      
      - name: Update Phase 1 Status
        if: success()
        run: |
          echo "Phase 1 validation passed at $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> math/STATUS.md

  validate-phase-2:
    name: Phase 2 - SCORE Comparison
    needs: [detect-changes, validate-phase-1]
    if: |
      always() &&
      (needs.detect-changes.outputs.experiments == 'true' ||
       github.event.inputs.phase == '2' ||
       github.event.inputs.phase == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install numpy scipy pandas matplotlib tracemalloc-utils pytest
      
      - name: Run SCORE implementation
        run: |
          if [ -f "experiments/02_score_comparison/score_implementation.py" ]; then
            python experiments/02_score_comparison/score_implementation.py
          else
            echo "::warning::score_implementation.py not found - skipping"
          fi
      
      - name: Run ATOMiK implementation
        run: |
          if [ -f "experiments/02_score_comparison/atomik_implementation.py" ]; then
            python experiments/02_score_comparison/atomik_implementation.py
          else
            echo "::warning::atomik_implementation.py not found - skipping"
          fi
      
      - name: Execute benchmark harness
        run: |
          if [ -f "experiments/02_score_comparison/benchmark_harness.py" ]; then
            python experiments/02_score_comparison/benchmark_harness.py
          else
            echo "::warning::benchmark_harness.py not found - skipping"
          fi
      
      - name: Verify statistical significance
        run: |
          echo "Checking p-value < 0.05 for performance comparisons"
          # Placeholder for statistical validation
      
      - name: Update Phase 2 Status
        if: success()
        run: |
          echo "Phase 2 validation passed at $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> experiments/02_score_comparison/STATUS.md

  validate-phase-3:
    name: Phase 3 - Hardware Synthesis
    needs: [detect-changes, validate-phase-2]
    if: |
      always() &&
      (needs.detect-changes.outputs.hardware == 'true' ||
       github.event.inputs.phase == '3' ||
       github.event.inputs.phase == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Verilog tools
        run: |
          sudo apt-get update
          sudo apt-get install -y iverilog verilator
      
      - name: Lint Verilog modules
        run: |
          cd hardware/verilog
          for v_file in *.v; do
            if [ -f "$v_file" ]; then
              verilator --lint-only "$v_file" 2>&1 || echo "::warning::Lint warnings in $v_file"
            fi
          done
      
      - name: Run testbenches
        run: |
          cd hardware/testbenches
          for tb_file in tb_*.v; do
            if [ -f "$tb_file" ]; then
              module_name=$(basename "$tb_file" .v)
              iverilog -o "${module_name}.vvp" "$tb_file" ../verilog/*.v 2>&1 || true
              if [ -f "${module_name}.vvp" ]; then
                vvp "${module_name}.vvp" || echo "::warning::Testbench $tb_file failed"
              fi
            fi
          done
      
      - name: Check resource utilization
        run: |
          echo "Verifying resource usage < 80% of GW1NR-9 capacity"
          echo "LUTs: 8640 available, FFsl 6480 available"
          # Placeholder for synthesis report parsing
      
      - name: Update Phase 3 Status
        if: success()
        run: |
          echo "Phase 3 validation passed at $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> hardware/STATUS.md

  validate-phase-4:
    name: Phase 4 - SDK Development
    needs: [detect-changes, validate-phase-3]
    if: |
      always() &&
      (needs.detect-changes.outputs.software == 'true' ||
       github.event.inputs.phase == '4' ||
       github.event.inputs.phase == 'all')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install SDK and test dependencies
        run: |
          pip install -e ./software/atomik_sdk[dev] || pip install numpy scipy pytest pytest-cov
      
      - name: Run unit tests with coverage
        run: |
          cd software
          python -m pytest tests/ -v --cov=atomik_sdk --cov-report=xml --cov-report=html || true
      
      - name: Check coverage threshold
        run: |
          echo "Verifying test coverage >= 90%"
          # Coverage check placeholder
      
      - name: Test example notebooks
        run: |
          pip install jupyter nbconvert
          cd software/examples
          for notebook in *.ipynb; do
            if [ -f "$notebook" ]; then
              jupyter nbconvert --execute --to notebook "$notebook" 2>&1 || echo "::warning::Example $notebook failed"
            fi
          done
      
      - name: Update Phase 4 Status
        if: success()
        run: |
          echo "Phase 4 validation passed at $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> software/STATUS.md

  update-global-status:
    name: Update Global Status
    needs: [validate-phase-1, validate-phase-2, validate-phase-3, validate-phase-4]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate status report
        run: |
          echo "# Global Status Update" > status_update.md
          echo "Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> status_update.md
          echo "" >> status_update.md
          echo "| Phase | Status |" >> status_update.md
          echo "|-------|--------|" >> status_update.md
          echo "| Phase 1 | ${{ needs.validate-phase-1.result }} |" >> status_update.md
          echo "| Phase 2 | ${{ needs.validate-phase-2.result }} |" >> status_update.md
          echo "| Phase 3 | ${{ needs.validate-phase-3.result }} |" >> status_update.md
          echo "| Phase 4 | ${{ needs.validate-phase-4.result }} |" >> status_update.md
      
      - name: Commit status update
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          cat status_update.md >> docs/GLOBAL_STATUS.md
          git add docs/GLOBAL_STATUS.md
          git diff --staged --quiet || git commit -m "[documenter] chore(docs): update global status"
          git push || echo "::warning::Could not push status update"
