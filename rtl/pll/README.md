# ATOMiK PLL Modules

PLL (Phase-Locked Loop) configurations for ATOMiK project targeting Tang Nano 9K.

---

## Available PLL Configurations

| Module | Output Freq | Dynamic | Status | Location |
|--------|-------------|---------|--------|----------|
| `atomik_pll_94p5m` | 94.5 MHz | No | ✅ **Active** | `atomik_pll_94p5m.v` |
| `atomik_pll_81m` | 81.0 MHz | No | Available | `atomik_pll_81m.v` |
| `Gowin_rPLL` | Variable | Yes (idsel) | Available | `gowin_rpll/gowin_rpll.v` |

---

## Current Configuration

`atomik_top.v` uses `atomik_pll_94p5m`:

```verilog
parameter integer SYS_CLK_HZ = 94_500_000;  // 94.5 MHz
```

### Frequency Calculation

```
Input:   27 MHz (Tang Nano 9K crystal)
IDIV:    2 (IDIV_SEL = 1)
FBDIV:   7 (FBDIV_SEL = 6)
ODIV:    8 (ODIV_SEL = 8)

fCLKOUT = 27 MHz × 7 / 2 = 94.5 MHz
fVCO    = 94.5 MHz × 8 = 756 MHz (valid: 400-1200 MHz)
```

---

## Module Interfaces

### Static PLL (atomik_pll_94p5m, atomik_pll_81m)

```verilog
module atomik_pll_Xm (
    output clkout,    // PLL output clock
    output lock,      // PLL lock indicator (HIGH = locked)
    input  reset,     // Active-HIGH reset
    input  clkin      // 27 MHz input clock
);
```

### Dynamic PLL (Gowin_rPLL)

```verilog
module Gowin_rPLL (
    output clkout,        // PLL output clock
    output lock,          // PLL lock indicator
    input  reset,         // Active-HIGH reset
    input  clkin,         // 27 MHz input clock
    input  [5:0] idsel    // Dynamic input divider select
);
```

---

## Instantiation Examples

### Using Static PLL (Recommended)

```verilog
atomik_pll_94p5m u_pll (
    .clkin  (sys_clk),       // 27 MHz from crystal
    .reset  (~sys_rst_n),    // Invert active-low reset
    .clkout (clk_pll),       // 94.5 MHz output
    .lock   (pll_lock)       // Lock indicator
);
```

### Using Dynamic PLL

```verilog
Gowin_rPLL u_pll (
    .clkin  (sys_clk),
    .reset  (pll_reset),
    .clkout (clk_pll),
    .lock   (pll_lock),
    .idsel  (6'b000000)      // Select divider dynamically
);
```

---

## Gowin rPLL IP Core Files

Generated by Gowin IP Core Generator (V1.9.11.03 Education):

| File | Purpose |
|------|---------|
| `gowin_rpll/gowin_rpll.v` | Main IP module with dynamic IDIV |
| `gowin_rpll/gowin_rpll_tmp.v` | Instantiation template |
| `gowin_rpll/gowin_rpll.ipc` | IP configuration (reload in Gowin EDA) |
| `gowin_rpll/gowin_rpll.mod` | Module metadata |

---

## Changing PLL Frequency

### Option 1: Use Different Static Module

Edit `atomik_top.v`:

```verilog
// Change from:
atomik_pll_94p5m u_pll (...)

// To:
atomik_pll_81m u_pll (...)

// And update parameter:
parameter integer SYS_CLK_HZ = 81_000_000;
```

### Option 2: Generate New PLL

1. Open Gowin EDA
2. Tools → IP Core Generator → Hard Module → rPLL
3. Set input frequency: 27 MHz
4. Set output frequency: desired value
5. Generate to `rtl/pll/`

### Option 3: Use Dynamic PLL

Wire `idsel` to configuration register for runtime frequency changes.

---

## GW1NR-9 PLL Specifications

| Parameter | C6/I5 Grade | Unit |
|-----------|-------------|------|
| CLKIN | 3 - 400 | MHz |
| VCO | 400 - 1200 | MHz |
| CLKOUT | 3.125 - 600 | MHz |

**Important**: VCO must stay within range for PLL to lock.

---

## Troubleshooting

### PLL Won't Lock

1. Verify input clock is present (27 MHz)
2. Check reset polarity (active-HIGH for rPLL)
3. Verify VCO frequency is within 400-1200 MHz
4. Ensure sufficient reset hold time after power-up

### Wrong Output Frequency

1. Verify divider settings match expected values
2. Remember: IDIV = IDIV_SEL + 1, FBDIV = FBDIV_SEL + 1
3. Check formula: fCLKOUT = fCLKIN × FBDIV / IDIV

---

## Reference Documentation

| Document | Location |
|----------|----------|
| Clock Reference | `docs/reference/gowin/CLOCK_REFERENCE.md` |
| Gowin Clock User Guide | UG286-1.9.1E |
| GW1NR Datasheet | DS117-2.9.3E (Table 4-21) |
| IP Core Generator Guide | SUG284-2.1E |

---

*Last Updated: January 25, 2026*
